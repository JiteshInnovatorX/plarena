<!DOCTYPE html>
<html lang="en" ng-app="finderApp">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tournament Finder</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.8.3/angular.min.js"></script>
</head>
<body ng-controller="finderController" class="bg-light">
  <div class="container mt-5">
    <h2 class="mb-4 text-center">Tournament Finder</h2>
    <form class="row g-3 justify-content-center mb-4">
      <div class="col-md-3">
        <label>Sports</label>
        <select class="form-select" ng-model="search.sports" ng-options="s for s in sportsList">
          <option value="">All</option>
        </select>
      </div>
      <div class="col-md-3">
        <label>City</label>
        <select class="form-select" ng-model="search.city" ng-options="c for c in cityList">
          <option value="">All</option>
        </select>
      </div>
      <div class="col-md-2">
        <label>Your Age</label>
        <input type="number" min="5" max="100" class="form-control" ng-model="search.age" placeholder="Age"/>
      </div>
      <div class="col-md-2 align-self-end">
        <button type="button" class="btn btn-primary w-100" ng-click="doSearch()">Find Now</button>
      </div>
    </form>

    <!-- Results table -->
    <table class="table table-bordered table-striped" ng-if="results.length">
      <thead class="table-dark">
        <tr>
          <th>Event</th>
          <th>Date</th>
          <th>City</th>
          <th>Sports</th>
          <th>Age Group</th>
          <th>Fee</th>
          <th>Prize</th>
        </tr>
      </thead>
      <tbody>
        <tr ng-repeat="t in results">
          <td>{{t.event}}</td>
          <td>{{t.doe | date:'yyyy-MM-dd'}}</td>
          <td>{{t.city}}</td>
          <td>{{t.sports}}</td>
          <td>{{t.minage}}-{{t.maxage}}</td>
          <td>{{t.fee}}</td>
          <td>{{t.prize}}</td>
        </tr>
      </tbody>
    </table>
    <div ng-if="!results.length && searched" class="alert alert-info">No tournaments found for your selection.</div>
  </div>

  <script>
    var app = angular.module('finderApp', []);
    app.controller('finderController', function($scope, $http) {
      $scope.sportsList = [];
      $scope.cityList = [];
      $scope.results = [];
      $scope.search = {};
      $scope.searched = false;

      // Load sports/cities for dropdowns on page load
      $http.get("/distinctSports").then(res => $scope.sportsList = res.data);
      $http.get("/distinctCities").then(res => $scope.cityList = res.data);

      $scope.doSearch = function() {
        const params = {};
        if($scope.search.sports) params.sports = $scope.search.sports;
        if($scope.search.city) params.city = $scope.search.city;
        if($scope.search.age) params.age = $scope.search.age;
        $http.get("/searchTournaments", { params }).then(function(res){
          $scope.results = res.data;
          $scope.searched = true;
        }, function() { alert("DB error"); });
      };
    });
  </script>
</body>
</html>
