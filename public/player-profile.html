<!DOCTYPE html>
<html lang="en" ng-app="playerModule">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Plarena â€” Player Profile</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.8.3/angular.min.js"></script>
</head>
<body ng-controller="playerController" class="bg-light">
  <div class="container mt-5">
    <h2 class="mb-4 text-center">Plarena Player Profile</h2>
    <form class="bg-white shadow rounded p-4">
      <!-- ... your form fields ... -->
      <!-- code unchanged from your latest, for brevity ... -->
    </form>
  </div>
  <script>
    var app = angular.module('playerModule', []);
    app.controller('playerController', function($scope, $http) {
      const API_BASE = "https://plarena-2.onrender.com"; // Cloud backend URL
      $scope.player = {};

      // Upload Adhaar (calls /uploadImage)
      $scope.uploadAdhaar = function(files) {
        var file = files[0];
        var formData = new FormData();
        formData.append("image", file);
        $http.post(
          API_BASE + "/uploadImage",
          formData,
          { headers: { 'Content-Type': undefined }, transformRequest: angular.identity }
        ).then(function(res) {
          $scope.player.acardpicurl = res.data.url;
          $scope.$applyAsync && $scope.$applyAsync();
          alert("Adhaar uploaded!");
        }, function() { alert("Adhaar upload failed."); });
      };

      // Upload Profile Pic (calls /uploadImage)
      $scope.uploadProfilePic = function(files) {
        var file = files[0];
        var formData = new FormData();
        formData.append("image", file);
        $http.post(
          API_BASE + "/uploadImage",
          formData,
          { headers: { 'Content-Type': undefined }, transformRequest: angular.identity }
        ).then(function(res) {
          $scope.player.profilepicurl = res.data.url;
          $scope.$applyAsync && $scope.$applyAsync();
          alert("Profile pic uploaded!");
        }, function() { alert("Profile pic upload failed."); });
      };

      // Fetch player profile
      $scope.fetch = function() {
        if (!$scope.player.emailid) return alert("Enter Email!");
        $http.get(API_BASE + "/getPlayerProfile?emailid=" + $scope.player.emailid).then(function(res) {
          if(res.data) $scope.player = res.data;
          else alert("Player not found!");
        }, function() { alert("DB Error"); });
      };

      // Save or modify profile
      $scope.save = function() {
        $http.post(API_BASE + "/updatePlayerProfile", $scope.player).then(function(res) {
          alert(res.data.message || "Saved!");
        }, function() { alert("Error saving"); });
      };
    });

    // === AI Aadhaar autofill logic (calls /picreader) ===
    function verifyAadhaarAndAutofill() {
      var API_BASE = "https://plarena-2.onrender.com";
      var fileInput = document.getElementById('aiAdhaarInput');
      if (!fileInput.files.length) return alert("Select an image!");
      var file = fileInput.files[0];
      var formData = new FormData();
      formData.append('imggg', file);
      fetch(API_BASE + '/picreader', { method: 'POST', body: formData })
        .then(resp => resp.json())
        .then(json => {
          var scope = angular.element(document.body).scope();
          scope.$apply(function() {
            if(json.name) scope.player.name = json.name;
            if(json.gender) scope.player.gender = json.gender;
            if(json.dob) scope.player.dob = json.dob;
            if(json.adhaar_number) scope.player.aadhaar = json.adhaar_number;
          });
          alert("Aadhaar details auto-filled by AI!");
        })
        .catch(() => alert("Could not verify Aadhaar!"));
    }
  </script>
</body>
</html>
