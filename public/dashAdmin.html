<!DOCTYPE html>
<html lang="en" ng-app="adminApp">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Plarena — Admin Console</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.8.3/angular.min.js"></script>
</head>
<body ng-controller="adminController" class="container mt-5">
  <h2 class="mb-4 text-center">Plarena Admin Console</h2>
  
  <!-- Tabs -->
  <ul class="nav nav-tabs mb-4">
    <li class="nav-item">
      <a class="nav-link" ng-class="{'active':tab==1}" ng-click="tab=1" href="#">Users</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" ng-class="{'active':tab==2}" ng-click="tab=2" href="#">Players</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" ng-class="{'active':tab==3}" ng-click="tab=3" href="#">Organizers</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" ng-class="{'active':tab==4}" ng-click="tab=4" href="#">Tournaments</a>
    </li>
  </ul>

  <!-- Users Tab -->
  <div ng-show="tab==1">
    <h4>All Users</h4>
    <table class="table table-bordered table-striped">
      <thead class="table-dark">
        <tr>
          <th>Email</th>
          <th>Type</th>
          <th>Date of Signup</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        <tr ng-repeat="user in users">
          <td>{{user.emailid}}</td>
          <td>{{user.utype}}</td>
          <td>{{user.dos | date:'yyyy-MM-dd'}}</td>
          <td>
            <span class="badge" ng-class="{'bg-success': user.status==1, 'bg-danger': user.status==0}">
              {{user.status==1 ? 'Active' : 'Blocked'}}
            </span>
          </td>
          <td>
            <button ng-if="user.status==1" class="btn btn-sm btn-danger" ng-click="blockUser(user.emailid)">Block</button>
            <button ng-if="user.status==0" class="btn btn-sm btn-success" ng-click="resumeUser(user.emailid)">Resume</button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Players Tab -->
  <div ng-show="tab==2">
    <h4>All Players</h4>
    <table class="table table-bordered table-striped">
      <thead class="table-dark">
        <tr>
          <th>Email</th>
          <th>Name</th>
          <th>Gender</th>
          <th>Contact</th>
          <th>Game</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr ng-repeat="p in players">
          <td>{{p.emailid}}</td>
          <td>{{p.name}}</td>
          <td>{{p.gender}}</td>
          <td>{{p.contact}}</td>
          <td>{{p.game}}</td>
          <td>
            <span class="badge" ng-class="{'bg-success':getUserStatus(p.emailid)==1,'bg-danger':getUserStatus(p.emailid)==0}">
              {{getUserStatus(p.emailid)==1?'Active':'Blocked'}}
            </span>
          </td>
          <td>
            <button ng-if="getUserStatus(p.emailid)==1" class="btn btn-sm btn-danger" ng-click="blockUser(p.emailid)">Block</button>
            <button ng-if="getUserStatus(p.emailid)==0" class="btn btn-sm btn-success" ng-click="resumeUser(p.emailid)">Resume</button>
            <button class="btn btn-sm btn-outline-danger" ng-click="deletePlayer(p.emailid)">Delete</button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Organizers Tab -->
  <div ng-show="tab==3">
    <h4>All Organizers</h4>
    <table class="table table-bordered table-striped">
      <thead class="table-dark">
        <tr>
          <th>Email</th>
          <th>Org Name</th>
          <th>City</th>
          <th>Contact</th>
          <th>Sports</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr ng-repeat="o in organizers">
          <td>{{o.emailid}}</td>
          <td>{{o.orgname}}</td>
          <td>{{o.city}}</td>
          <td>{{o.contact}}</td>
          <td>{{o.sports}}</td>
          <td>
            <span class="badge" ng-class="{'bg-success':getUserStatus(o.emailid)==1,'bg-danger':getUserStatus(o.emailid)==0}">
              {{getUserStatus(o.emailid)==1?'Active':'Blocked'}}
            </span>
          </td>
          <td>
            <button ng-if="getUserStatus(o.emailid)==1" class="btn btn-sm btn-danger" ng-click="blockUser(o.emailid)">Block</button>
            <button ng-if="getUserStatus(o.emailid)==0" class="btn btn-sm btn-success" ng-click="resumeUser(o.emailid)">Resume</button>
            <button class="btn btn-sm btn-outline-danger" ng-click="deleteOrganizer(o.emailid)">Delete</button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Tournaments Tab -->
  <div ng-show="tab==4">
    <h4>All Tournaments</h4>
    <table class="table table-bordered table-striped">
      <thead class="table-dark">
        <tr>
          <th>Event</th>
          <th>Organizer</th>
          <th>City</th>
          <th>Date</th>
          <th>Sports</th>
          <th>Fee</th>
          <th>Prize</th>
        </tr>
      </thead>
      <tbody>
        <tr ng-repeat="t in tournaments">
          <td>{{t.event}}</td>
          <td>{{t.emailid}}</td>
          <td>{{t.city}}</td>
          <td>{{t.doe | date:'yyyy-MM-dd'}}</td>
          <td>{{t.sports}}</td>
          <td>{{t.fee}}</td>
          <td>{{t.prize}}</td>
        </tr>
      </tbody>
    </table>
  </div>

  <script>
    var app = angular.module('adminApp', []);
    app.controller('adminController', function($scope, $http) {
      const API_BASE = "https://plarena-2.onrender.com";
      $scope.tab = 1;
      $scope.users = [];
      $scope.players = [];
      $scope.organizers = [];
      $scope.tournaments = [];
      $scope.userMap = {};

      // Fetch all data
      $http.get(API_BASE + "/admin/users").then(function(res) {
        $scope.users = res.data;
        res.data.forEach(u => $scope.userMap[u.emailid] = u.status);
      });
      $http.get(API_BASE + "/admin/players").then(res => $scope.players = res.data);
      $http.get(API_BASE + "/admin/organizers").then(res => $scope.organizers = res.data);
      $http.get(API_BASE + "/admin/tournaments").then(res => $scope.tournaments = res.data);

      // Get user status
      $scope.getUserStatus = function(emailid) {
        return $scope.userMap[emailid];
      };

      // Block user
      $scope.blockUser = function(emailid) {
        $http.put(API_BASE + "/admin/user/" + emailid + "/block").then(function() {
          $scope.userMap[emailid] = 0;
          const user = $scope.users.find(u => u.emailid === emailid);
          if(user) user.status = 0;
          alert("User blocked!");
        });
      };

      // Resume user
      $scope.resumeUser = function(emailid) {
        $http.put(API_BASE + "/admin/user/" + emailid + "/resume").then(function() {
          $scope.userMap[emailid] = 1;
          const user = $scope.users.find(u => u.emailid === emailid);
          if(user) user.status = 1;
          alert("User resumed!");
        });
      };

      // Delete player
      $scope.deletePlayer = function(emailid) {
        if(confirm("Delete this player?")) {
          $http.delete(API_BASE + "/admin/player/" + emailid).then(function() {
            $scope.players = $scope.players.filter(p => p.emailid !== emailid);
            delete $scope.userMap[emailid];
            alert("Player deleted!");
          });
        }
      };

      // Delete organizer
      $scope.deleteOrganizer = function(emailid) {
        if(confirm("Delete this organizer?")) {
          $http.delete(API_BASE + "/admin/organizer/" + emailid).then(function() {
            $scope.organizers = $scope.organizers.filter(o => o.emailid !== emailid);
            delete $scope.userMap[emailid];
            alert("Organizer deleted!");
          });
        }
      };
    });

    document.addEventListener("DOMContentLoaded", function() {
      const email = localStorage.getItem("userEmail");
      const utype = localStorage.getItem("userType");

      // ✅ Only allow your admin email or Admin user type
      if (email !== "jitesh365days@gmail.com" && utype !== "Admin") {
        alert("Access denied! Admins only.");
        window.location.href = "index.html";
      }
    });
  </script>
</body>
</html>
